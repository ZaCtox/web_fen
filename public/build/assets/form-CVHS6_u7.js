(()=>{const n=(o,t=document)=>t.querySelector(o),R=(o,t=document)=>Array.from(t.querySelectorAll(o));function C(o,t){const[e,i]=(o||"00:00").split(":").map(Number),s=new Date(2e3,1,1,e,i,0);s.setMinutes(s.getMinutes()+t);const r=d=>d<10?"0"+d:""+d;return`${r(s.getHours())}:${r(s.getMinutes())}`}function I(o){return Object.entries(o).filter(([t,e])=>e!=null&&e!=="").map(([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&")}function M(){const o=n("#magister");if(!o)return{};try{const t=o.dataset.agrupados||"{}";console.log("[CLASES] data-agrupados raw length:",t==null?void 0:t.length);const e=JSON.parse(t);return console.log("[CLASES] parseAgrupados keys:",Object.keys(e)),e}catch{return console.warn("[CLASES] parseAgrupados JSON invÃ¡lido"),window.AGRUPADOS?(console.log("[CLASES] usando window.AGRUPADOS como fallback"),window.AGRUPADOS):{}}}function D(){const o=n("#magister"),t=n("#course_id"),e=n("#period_id"),i=n("#periodo_info"),s=n("#trimestre"),r=n("#anio");if(!o||!t)return;const d=M();o.addEventListener("change",()=>{const a=o.value;console.log("[CLASES] Programa cambiado:",a),t.innerHTML='<option value="">-- Asignatura --</option>',e&&(e.value=""),i&&(i.innerHTML="<option>Selecciona un curso para ver el perÃ­odo</option>"),s&&(s.value=""),r&&(r.value=""),d[a]&&(console.log("[CLASES] Cursos del programa:",d[a]),d[a].forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=l.nombre,c.dataset.period_id=l.period_id,c.dataset.periodo=l.periodo,c.dataset.period_numero=l.numero??"",c.dataset.period_anio=l.anio??"",t.appendChild(c)}))}),t.addEventListener("change",()=>{var b,v,p,h;const a=t.options[t.selectedIndex],l=((b=a==null?void 0:a.dataset)==null?void 0:b.period_id)??"",c=((v=a==null?void 0:a.dataset)==null?void 0:v.periodo)??"",u=((p=a==null?void 0:a.dataset)==null?void 0:p.period_numero)||"",f=((h=a==null?void 0:a.dataset)==null?void 0:h.period_anio)||"";e&&(e.value=l),i&&(i.innerHTML=`<option>${c?"ðŸ“˜ "+c:"Sin periodo asignado"}</option>`),s&&(s.value=u),r&&(r.value=f),console.log("[CLASES] Asignatura cambiada:",{periodId:l,periodo:c,numero:u,anio:f})}),function(){var v;const l=(v=n("#magister"))==null?void 0:v.value,c=M();l&&c[l]&&t.options.length<=1&&c[l].forEach(p=>{const h=document.createElement("option");h.value=p.id,h.textContent=p.nombre,h.dataset.period_id=p.period_id,h.dataset.periodo=p.periodo,h.dataset.period_numero=p.numero??"",h.dataset.period_anio=p.anio??"",t.appendChild(h)});const u=t.options[t.selectedIndex];if(!u)return;const f=u.dataset.period_numero||"",b=u.dataset.period_anio||"";s&&(s.value=f),r&&(r.value=b),console.log("[CLASES] HidrataciÃ³n inicial:",{selectedCourseId:u.value,numero:f,anio:b})}()}function T(){const o=n("#modality"),t=n("#room_id"),e=n('input[name="url_zoom"]');if(!o||!t)return;const i=document.querySelector('[data-field-id="room_id"]'),s=()=>{o.value==="online"?(t.value="",t.disabled=!0,i&&i.classList.add("hidden")):(t.disabled=!1,i&&i.classList.remove("hidden")),e&&(o.value==="online"||o.value==="hibrida"?(e.required=!0,e.parentElement.classList.remove("hidden")):(e.required=!1,e.parentElement.classList.add("hidden")));const r=n("#slots-wrap"),d=n("#slots");o.value==="online"&&(d&&(d.innerHTML=""),r&&r.classList.add("hidden"))};s(),o.addEventListener("change",s)}window.disponibilidadSala=function(){const o=n("#form-clase"),t=(o==null?void 0:o.dataset.urlDisponibilidad)||"";return{checking:!1,available:null,conflicts:[],timer:null,payload(e={}){var i,s,r,d,a,l;return{room_id:((i=n("#room_id"))==null?void 0:i.value)||"",period_id:((s=n("#period_id"))==null?void 0:s.value)||"",dia:((r=n('select[name="dia"]'))==null?void 0:r.value)||"",hora_inicio:((d=n('input[name="hora_inicio"]'))==null?void 0:d.value)||"",hora_fin:((a=n('input[name="hora_fin"]'))==null?void 0:a.value)||"",modality:((l=n("#modality"))==null?void 0:l.value)||"",...e}},debounceCheck(e={}){clearTimeout(this.timer),this.timer=setTimeout(()=>this.check(e),400)},async check(e={}){var r;const i=this.payload(e);if(i.modality==="online"||!i.period_id||!i.dia||!i.hora_inicio||!i.hora_fin){this.available=!0,this.conflicts=[];return}if(!i.room_id){this.available=!0,this.conflicts=[];return}this.checking=!0,this.available=null,this.conflicts=[];const s=I(i);try{const a=await(await fetch(`${t}?${s}`,{headers:{Accept:"application/json"}})).json();this.available=!!a.available,this.conflicts=a.conflicts||[]}catch(d){this.available=!0,this.conflicts=[],console.error("Error disponibilidad:",d)}finally{this.checking=!1,(r=n('button[type="submit"]'))==null||r.toggleAttribute("disabled",this.available===!1)}},initCreate(){const e=(s,r="change")=>{const d=n(s);d&&d.addEventListener(r,()=>this.debounceCheck())};e("#room_id"),e("#period_id"),e('select[name="dia"]'),e('input[name="hora_inicio"]',"input"),e('input[name="hora_fin"]',"input"),e("#modality");const i=n("#course_id");i==null||i.addEventListener("change",()=>this.debounceCheck()),this.debounceCheck()}}},window.disponibilidadSalaEdit=function(o){const t=window.disponibilidadSala(),e=t.payload.bind(t);return t.payload=function(i={}){return e({exclude_id:o,...i})},t.initEdit=function(){this.initCreate()},t};function $(){var i;const o=n("#help-huecos");if(!o)return;const t=parseInt(((i=n("#block_count"))==null?void 0:i.value)||"1",10),e=t*60;o.textContent=`Busca huecos de ${t} bloque(s) (${e} min).`}function N(){const o=n("#btn-horarios");if(!o)return;const t=n("#slots-wrap"),e=n("#slots"),i=n("#period_id"),s=n("#room_id"),r=n('select[name="dia"]'),d=n("#modality"),a=n("#block_count"),l=o.dataset.urlHorarios||"",c=o.dataset.excludeId?parseInt(o.dataset.excludeId,10):null;R("#block_count").forEach(u=>u.addEventListener("change",$)),$(),o.addEventListener("click",async()=>{const u=i==null?void 0:i.value,f=s==null?void 0:s.value,b=r==null?void 0:r.value,v=d==null?void 0:d.value;if(!u){alert("Primero selecciona una asignatura para obtener el perÃ­odo.");return}if(v!=="online"&&!f){alert("Selecciona una sala (o cambia a modalidad online).");return}if(!b){alert("Selecciona el dÃ­a.");return}const p=Math.max(1,Math.min(5,parseInt((a==null?void 0:a.value)||"1",10))),h=p*60,O={period_id:u,room_id:f,dia:b,modality:v,exclude_id:c??"",desde:"08:00",hasta:"22:00",min_block:h,buffer:10,blocks:p};try{const k=`${l}?${I(O)}`,L=await(await fetch(k,{headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(e.innerHTML="",t.classList.remove("hidden"),L.slots&&L.slots.length){const S=parseInt(L.blocks||1,10),P=parseInt(L.block_minutes||60,10),A=S*P+(S>1?(S-1)*10:0);L.slots.forEach(y=>{let x=y.start,q=0;for(;C(x,A)<=y.end;){const g=x,w=C(g,A),m=document.createElement("button");m.type="button",m.className="px-3 py-1 text-xs rounded bg-green-100 text-green-800 hover:bg-green-200",m.textContent=`${g}â€“${w} (${S} bloques)`,m.addEventListener("click",()=>{const _=n('input[name="hora_inicio"]'),E=n('input[name="hora_fin"]');_&&(_.value=g,_.dispatchEvent(new Event("input",{bubbles:!0}))),E&&(E.value=w,E.dispatchEvent(new Event("input",{bubbles:!0})))}),e.appendChild(m),x=C(x,15),q++}if(!q){const g=C(y.end,-A);if(g>=y.start){const w=y.end,m=document.createElement("button");m.type="button",m.className="px-3 py-1 text-xs rounded bg-green-100 text-green-800 hover:bg-green-200",m.textContent=`${g}â€“${w} (${S} bloques)`,m.addEventListener("click",()=>{const _=n('input[name="hora_inicio"]'),E=n('input[name="hora_fin"]');_&&(_.value=g,_.dispatchEvent(new Event("input",{bubbles:!0}))),E&&(E.value=w,E.dispatchEvent(new Event("input",{bubbles:!0})))}),e.appendChild(m)}}}),e.children.length||(e.innerHTML='<span class="text-sm text-red-600">No hay huecos del tamaÃ±o solicitado en los slots disponibles.</span>')}else e.innerHTML='<span class="text-sm text-red-600">No hay huecos libres con las condiciones actuales.</span>'}catch(k){console.error(k),alert("No se pudo obtener la disponibilidad.")}})}function H(){D(),T(),N()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",H):H()})();
