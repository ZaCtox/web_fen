document.addEventListener("DOMContentLoaded",function(){var h,I,B,w,S;const v=document.getElementById("calendar"),f=((h=document.querySelector('meta[name="csrf-token"]'))==null?void 0:h.content)||"",$=((I=document.querySelector('meta[name="store-url"]'))==null?void 0:I.content)||"",k=((B=document.querySelector('meta[name="clases-show-base"]'))==null?void 0:B.content)||"/clases",i=document.getElementById("magister-filter"),m=document.getElementById("room-filter"),y=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),L=e=>`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${{presencial:"bg-green-100 text-green-800",online:"bg-indigo-100 text-indigo-800",hibrida:"bg-yellow-100 text-yellow-800"}[e]||"bg-gray-100 text-gray-800"}">${e}</span>`,T=e=>{const t=String(e).split("-");return t[0]==="clase"&&t[1]?t[1]:null},P=e=>{var b,_;const t=e.extendedProps.type==="clase",n=t?T(e.id):null,o=((b=e.extendedProps.magister)==null?void 0:b.name)||"—",d=e.extendedProps.modality||"—",a=e.extendedProps.profesor||e.extendedProps.teacher||"—",l=((_=e.extendedProps.room)==null?void 0:_.name)||"Sin sala",u=y(e.start),c=y(e.end),s=e.extendedProps.url_zoom||null,g=e.extendedProps.type==="manual"&&e.extendedProps.description||"",R=s?`<a href="${s}" target="_blank" rel="noopener"
             class="inline-flex items-center rounded px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700"
             title="Abrir Zoom">🔗 Zoom</a>`:"",N=t&&n?`<a href="${k}/${n}" target="_blank" rel="noopener"
             class="inline-flex items-center rounded px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700"
             title="Ver detalle de la clase">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
               <path d="M10 4a6 6 0 104.472 10.028l4.75 4.75 1.414-1.414-4.75-4.75A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"/>
             </svg>
          </a>`:"",V=g?`<div class="mt-2 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line">${g}</div>`:"";return`
      <div class="flex items-start justify-between gap-3">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">${e.title}</h2>
        <div class="flex items-center gap-2">${R}${N}</div>
      </div>

      ${V}

      <div class="mt-3 space-y-1 text-sm">
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Programa:</span> ${o}</div>
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Modalidad:</span> ${L(d)}</div>
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Profesor:</span> ${a}</div>
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Inicio:</span> ${u}</div>
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Fin:</span> ${c}</div>
        <div><span class="text-gray-500 dark:text-gray-400 font-medium">Sala:</span> ${l}</div>
      </div>
    `},r=new FullCalendar.Calendar(v,{initialView:"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek"},locale:"es",firstDay:1,slotMinTime:"08:30:00",slotMaxTime:"21:00:00",expandRows:!0,editable:!0,selectable:!0,select:D,eventClick:M,events:{url:v.dataset.url,extraParams:()=>({magister_id:(i==null?void 0:i.value)||"",room_id:(m==null?void 0:m.value)||""}),failure:e=>console.error("Error cargando eventos:",e)},eventDidMount:z,datesSet:e=>{const t=new Date(e.start),o=(6-t.getDay()+7)%7,d=new Date(t);d.setDate(t.getDate()+o),C(d)}});r.render(),i!=null&&i.value||Swal.fire({title:"Filtra por magíster",text:"Para una mejor visualización, selecciona un magíster desde el filtro superior.",icon:"info",confirmButtonText:"Entendido",timer:6e3,timerProgressBar:!0});const E=document.getElementById("cancel");E&&E.addEventListener("click",()=>{r.unselect(),window.closeModal()}),["modal","eventModal"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("click",n=>{n.target===t&&(r.unselect(),window.closeModal())})}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(r.unselect(),window.closeModal())}),(w=document.getElementById("btnAnterior"))==null||w.addEventListener("click",()=>x("anterior")),(S=document.getElementById("btnSiguiente"))==null||S.addEventListener("click",()=>x("siguiente"));async function x(e){const t=r.getDate().toISOString().split("T")[0];try{const n=await fetch(`/api/trimestre-${e}?fecha=${t}`);if(n.status===404){const a=await(await fetch("/api/trimestres-todos")).json();if(!a.length){Swal.fire({icon:"warning",title:"Sin trimestres registrados",text:"No hay ningún período académico cargado en el sistema."});return}const l=a.map(s=>new Date(s.fecha_inicio)),u=new Date(t);let c=null;e==="anterior"?c=l.filter(s=>s<u).sort((s,g)=>g-s)[0]:c=l.filter(s=>s>u).sort((s,g)=>s-g)[0],c?r.gotoDate(c.toISOString().split("T")[0]):Swal.fire({icon:"info",title:"Trimestre no disponible",text:e==="anterior"?"Ya estás en el trimestre más antiguo registrado.":"Ya estás en el trimestre más reciente registrado."});return}const o=await n.json();o.fecha_inicio&&r.gotoDate(o.fecha_inicio)}catch(n){console.error("Error consultando trimestre:",n),Swal.fire({icon:"error",title:"Error de conexión",text:"No se pudo consultar los trimestres. Intenta nuevamente."})}}[i,m].filter(Boolean).forEach(e=>{e.addEventListener("change",()=>r.refetchEvents())});async function C(e){const t=e.toISOString().split("T")[0];try{const o=await(await fetch(`/api/periodo-por-fecha?fecha=${t}`)).json(),d={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"},a=o.periodo?`Trimestre ${d[o.periodo.numero]||o.periodo.numero} del año ${o.periodo.anio}`:"Fuera de períodos académicos";document.getElementById("current-period-text").textContent=a}catch(n){console.error("Error cargando período:",n),document.getElementById("current-period-text").textContent="Error"}}function D(e){p();const t=document.getElementById("magister_id"),n=document.getElementById("room_id");t&&(i!=null&&i.value)&&(t.value=i.value),n&&(m!=null&&m.value)&&(n.value=m.value),document.getElementById("modal-header").textContent="Crear Evento",document.getElementById("start_time").value=e.startStr,document.getElementById("end_time").value=e.endStr,document.getElementById("modal").classList.remove("hidden"),r.unselect()}function M(e){const t=document.getElementById("event-modal-body");t.innerHTML=P(e.event);const n=document.getElementById("delete-btn"),o=document.getElementById("edit-btn");e.event.extendedProps.type==="manual"?(n.classList.remove("hidden"),n.setAttribute("data-id",e.event.id.replace("event-","")),o.classList.remove("hidden"),o.onclick=()=>O(e.event)):(n.classList.add("hidden"),o.classList.add("hidden")),document.getElementById("eventModal").classList.remove("hidden")}function O(e){var n,o;p();const t=d=>{const a=new Date(d),l=a.getTimezoneOffset()*6e4;return new Date(a-l).toISOString().slice(0,16)};document.getElementById("event_id").value=e.id.replace("event-",""),document.getElementById("modal-title-input").value=e.title,document.getElementById("modal-description-input").value=e.extendedProps.description||"",document.getElementById("magister_id").value=((n=e.extendedProps.magister)==null?void 0:n.id)??"",document.getElementById("room_id").value=((o=e.extendedProps.room)==null?void 0:o.id)||"",document.getElementById("start_time").value=t(e.start),document.getElementById("end_time").value=t(e.end),document.getElementById("modal-header").textContent="Editar Evento",document.getElementById("eventModal").classList.add("hidden"),document.getElementById("modal").classList.remove("hidden")}document.getElementById("event-form").addEventListener("submit",j);function j(e){e.preventDefault();const t=(document.getElementById("event_id").value||"").trim(),n={title:document.getElementById("modal-title-input").value,description:document.getElementById("modal-description-input").value,magister_id:document.getElementById("magister_id").value||null,start_time:document.getElementById("start_time").value,end_time:document.getElementById("end_time").value,room_id:document.getElementById("room_id").value||null,type:"manual"},o=t?`/events/${t}`:$,d=t?"PUT":"POST";if(!o){console.error('Falta meta[name="store-url"] o endpoint vacío'),Swal.fire({icon:"error",title:"Configuración faltante",text:"No se encontró la URL para guardar eventos."});return}fetch(o,{method:d,headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f},body:JSON.stringify(n)}).then(async a=>{if(!a.ok){let l=null;try{l=await a.json()}catch{}throw l||{message:"Error al guardar"}}return a.json()}).then(()=>{r.unselect(),r.refetchEvents(),window.closeModal(),Swal.fire({icon:"success",title:"Evento guardado",timer:1500,showConfirmButton:!1})}).catch(a=>{console.error("Save error:",a),Swal.fire({icon:"error",title:"Error al guardar el evento",text:a&&a.message?a.message:"Revisa los datos ingresados"})})}document.getElementById("delete-btn").addEventListener("click",A);function A(){const e=this.getAttribute("data-id");confirm("¿Estás seguro de eliminar este evento?")&&fetch(`/events/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":f}}).then(t=>{t.ok?(r.unselect(),r.refetchEvents(),window.closeModal(),Swal.fire({icon:"success",title:"Evento Eliminado",timer:1500,showConfirmButton:!1})):Swal.fire({icon:"error",title:"Error al eliminar el evento",text:"Intenta nuevamente"})})}function z(e){var u,c;const t=((u=e.event.extendedProps.magister)==null?void 0:u.name)||"Sin magíster",n=e.event.extendedProps.profesor||e.event.extendedProps.teacher||"Sin encargado",o=((c=e.event.extendedProps.room)==null?void 0:c.name)||"Sin sala",d=e.event.start.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=e.event.end.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),l=`${e.event.title}
👨‍🏫 ${n} 
🏛️ ${t}
🏫 ${o}
🕒 ${d} - ${a}`;e.el.setAttribute("title",l.trim())}window.closeModal=function(){document.getElementById("modal").classList.add("hidden"),document.getElementById("eventModal").classList.add("hidden"),p()};function p(){document.getElementById("event_id").value="",document.getElementById("event-form").reset(),document.getElementById("start_time").value="",document.getElementById("end_time").value=""}});
