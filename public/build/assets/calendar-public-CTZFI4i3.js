document.addEventListener("DOMContentLoaded",function(){var h;const f=document.getElementById("calendar"),u=document.getElementById("magister-filter"),p=document.getElementById("room-filter"),g=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),x=e=>`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${{presencial:"bg-green-100 text-green-800",online:"bg-indigo-100 text-indigo-800",hibrida:"bg-yellow-100 text-yellow-800"}[e]||"bg-gray-100 text-gray-800"}">${e||"—"}</span>`,y=((h=document.querySelector('meta[name="clases-show-base"]'))==null?void 0:h.content)||null,I=e=>{const t=String(e).match(/^clase-(\d+)-/);return t?t[1]:null},m=new FullCalendar.Calendar(f,{initialView:"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek"},locale:"es",firstDay:1,slotMinTime:"08:30:00",slotMaxTime:"21:00:00",expandRows:!0,editable:!1,selectable:!1,eventClick:B,events:{url:f.dataset.url,extraParams:()=>({magister_id:u.value||"",room_id:p.value||""}),failure:e=>console.error("Error cargando eventos:",e)},eventDidMount:S,datesSet:e=>{const t=new Date(e.start),n=(6-t.getDay()+7)%7,i=new Date(t);i.setDate(t.getDate()+n),w(i)}});m.render(),u.value||Swal.fire({title:"Filtra por magíster",text:"Para una mejor visualización, selecciona un magíster desde el filtro superior.",icon:"info",confirmButtonText:"Entendido",timer:6e3,timerProgressBar:!0}),document.getElementById("btnAnterior").addEventListener("click",()=>E("anterior")),document.getElementById("btnSiguiente").addEventListener("click",()=>E("siguiente"));async function E(e){const t=m.getDate().toISOString().split("T")[0];try{const a=await fetch(`/api/trimestre-${e}?fecha=${t}`);if(a.status===404){const s=await(await fetch("/api/trimestres-todos")).json();if(!s.length){Swal.fire({icon:"warning",title:"Sin trimestres registrados",text:"No hay ningún período académico cargado en el sistema."});return}const d=s.map(o=>new Date(o.fecha_inicio)),c=new Date(t);let r=null;e==="anterior"?r=d.filter(o=>o<c).sort((o,l)=>l-o)[0]:r=d.filter(o=>o>c).sort((o,l)=>o-l)[0],r?m.gotoDate(r.toISOString().split("T")[0]):Swal.fire({icon:"info",title:"Trimestre no disponible",text:e==="anterior"?"Ya estás en el trimestre más antiguo registrado.":"Ya estás en el trimestre más reciente registrado."});return}const n=await a.json();n.fecha_inicio&&m.gotoDate(n.fecha_inicio)}catch(a){console.error("Error consultando trimestre:",a),Swal.fire({icon:"error",title:"Error de conexión",text:"No se pudo consultar los trimestres. Intenta nuevamente."})}}[u,p].forEach(e=>{e.addEventListener("change",()=>m.refetchEvents())});async function w(e){const t=e.toISOString().split("T")[0];try{const n=await(await fetch(`/api/periodo-por-fecha?fecha=${t}`)).json(),i={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"},s=n.periodo?`Trimestre ${i[n.periodo.numero]||n.periodo.numero} del año ${n.periodo.anio}`:"Fuera de períodos académicos";document.getElementById("current-period-text").textContent=s}catch(a){console.error("Error cargando período:",a),document.getElementById("current-period-text").textContent="Error"}}function B(e){var o,l;const t=e.event.extendedProps||{};document.getElementById("modal-title").textContent=e.event.title;const a=document.getElementById("modal-description");a&&(a.textContent=t.description||"");const n=t.programa||(typeof t.magister=="string"?t.magister:((o=t.magister)==null?void 0:o.name)||"No especificado"),i=document.getElementById("modal-program");i&&(i.textContent=n);const s=document.getElementById("modal-magister-view");s&&(s.textContent=n);const d=document.getElementById("modal-modality");d&&(d.innerHTML=x(t.modality));const c=document.getElementById("modal-teacher");c&&(c.textContent=t.profesor||t.teacher||"—"),document.getElementById("modal-start").textContent=g(e.event.start),document.getElementById("modal-end").textContent=g(e.event.end),document.getElementById("modal-room").textContent=((l=t.room)==null?void 0:l.name)||"—";const r=document.getElementById("view-class-link");if(r){const v=I(e.event.id);y&&v&&t.type==="clase"?(r.href=`${y}/${v}`,r.classList.remove("hidden")):(r.classList.add("hidden"),r.removeAttribute("href"))}document.getElementById("eventModal").classList.remove("hidden")}function S(e){var r,o;const t=e.event.extendedProps||{},a=t.programa||(typeof t.magister=="string"?t.magister:((r=t.magister)==null?void 0:r.name)||"Sin programa"),n=t.profesor||t.teacher||"Sin encargado",i=((o=t.room)==null?void 0:o.name)||"Sin sala",s=g(e.event.start),d=g(e.event.end),c=`${e.event.title}
👨‍🏫 ${n}
🏛️ ${a}
🏫 ${i}
🕒 ${s} - ${d}`;e.el.setAttribute("title",c.trim())}window.closeModal=function(){document.getElementById("eventModal").classList.add("hidden")},document.getElementById("eventModal").addEventListener("click",e=>{e.target.id==="eventModal"&&window.closeModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&window.closeModal()})});
