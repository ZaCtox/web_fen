document.addEventListener("DOMContentLoaded",function(){var $;const x=document.getElementById("calendar"),h=document.getElementById("magister-filter"),I=document.getElementById("room-filter"),f=document.getElementById("anio-ingreso-filter"),i=document.getElementById("anio-filter"),a=document.getElementById("trimestre-filter"),E=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),T=e=>`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${{presencial:"bg-green-100 text-green-800",online:"bg-indigo-100 text-indigo-800",hibrida:"bg-yellow-100 text-yellow-800"}[e]||"bg-gray-100 text-gray-800"}">${e||"—"}</span>`,B=(($=document.querySelector('meta[name="clases-show-base"]'))==null?void 0:$.content)||null,S=e=>{const t=String(e).match(/^clase-(\d+)-/);return t?t[1]:null},M=e=>{var n;const t=S(e.id);return t||((n=e.extendedProps)==null?void 0:n.clase_id)||null},s=new FullCalendar.Calendar(x,{initialView:window.innerWidth<768?"listWeek":"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},locale:"es",buttonText:{today:"Hoy",month:"Mes",week:"Semana",day:"Día",list:"Lista"},firstDay:1,slotMinTime:"08:00:00",slotMaxTime:"22:00:00",slotDuration:"00:30:00",slotLabelFormat:{hour:"numeric",minute:"2-digit",hour12:!1},slotLabelInterval:"01:00:00",allDaySlot:!1,expandRows:!0,editable:!1,selectable:!1,eventClick:F,events:{url:x.dataset.url,extraParams:()=>({magister_id:h.value||"",room_id:I.value||"",anio_ingreso:f.value||"",anio:i.value||"",trimestre:a.value||""}),failure:e=>console.error("Error cargando eventos:",e)},eventDidMount:W,viewDidMount:function(e){const t="week-view-active",n=document.body;e.view.type==="timeGridWeek"?n.classList.add(t):n.classList.remove(t),e.view.type.startsWith("list")?(s.setOption("height","auto"),s.setOption("contentHeight","auto")):(s.setOption("height",window.innerHeight+200),s.setOption("contentHeight",null))},windowResize:function(){window.innerWidth<768?s.changeView("listWeek"):s.changeView("timeGridWeek")},datesSet:e=>{const t=new Date(e.start),o=(6-t.getDay()+7)%7,r=new Date(t);r.setDate(t.getDate()+o),L(r)}});s.render(),h.value||Swal.fire({title:"Filtra por magíster",text:"Para una mejor visualización, selecciona un magíster desde el filtro superior.",icon:"info",confirmButtonText:"Entendido",timer:6e3,timerProgressBar:!0}),[h,I,f].forEach(e=>{e.addEventListener("change",()=>{s.refetchEvents()})}),i&&i.addEventListener("change",()=>{D(),i.value&&a.value&&b(parseInt(i.value),parseInt(a.value)),s.refetchEvents()}),a&&a.addEventListener("change",()=>{i.value&&a.value&&b(parseInt(i.value),parseInt(a.value)),s.refetchEvents()});const C=document.getElementById("clear-filters");C&&C.addEventListener("click",()=>{if(h.value="",I.value="",i.value="",a){a.innerHTML='<option value="">Todos</option>';for(let e=1;e<=6;e++){const t=document.createElement("option");t.value=e,t.textContent=`Trimestre ${e}`,a.appendChild(t)}}s.refetchEvents()});function D(){if(!a||!i)return;const e=parseInt(i.value),t=a.value;if(a.innerHTML='<option value="">Todos</option>',e===1)for(let n=1;n<=3;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,n.toString()===t&&(o.selected=!0),a.appendChild(o)}else if(e===2)for(let n=4;n<=6;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,n.toString()===t&&(o.selected=!0),a.appendChild(o)}else for(let n=1;n<=6;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,a.appendChild(o)}}async function b(e,t){try{const o=await(await fetch(`/api/periodo-fecha-inicio?anio=${e}&trimestre=${t}&anio_ingreso=${f.value}`)).json();if(o.fecha_inicio){const r=new Date(o.fecha_inicio);s.changeView("timeGridWeek",r),await L(r)}}catch(n){console.error("Error navegando al trimestre:",n),Swal.fire({icon:"error",title:"Error de navegación",text:"No se pudo navegar al trimestre seleccionado."})}}async function L(e){if(i&&a&&i.value&&a.value){const r=`Trimestre ${{1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"}[a.value]||a.value} del año ${i.value}`;document.getElementById("current-period-text").textContent=r;return}const t=e.toISOString().split("T")[0],n=f?f.value:"";try{const o=`/api/periodo-por-fecha?fecha=${t}${n?`&anio_ingreso=${n}`:""}`,u=await(await fetch(o)).json(),d={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"},l=u.periodo?`Trimestre ${d[u.periodo.numero]||u.periodo.numero} del año ${u.periodo.anio}`:"Fuera de períodos académicos";document.getElementById("current-period-text").textContent=l}catch(o){console.error("Error cargando período:",o),document.getElementById("current-period-text").textContent="Error"}}function F(e){var o,r,u;const t=e.event.extendedProps||{},n=t.type==="break";if(document.getElementById("modal-title").textContent=e.event.title,n){Math.round((e.event.end-e.event.start)/6e4);const d=document.getElementById("modal-description");d&&(d.textContent=t.description||"");const l=document.getElementById("modal-program");l&&l.parentElement&&(l.parentElement.style.display="none");const c=document.getElementById("modal-magister-view");c&&c.parentElement&&(c.parentElement.style.display="none");const m=document.getElementById("modal-modality");m&&m.parentElement&&(m.parentElement.style.display="none");const v=document.getElementById("modal-teacher");v&&v.parentElement&&(v.parentElement.style.display="none"),document.getElementById("modal-start").textContent=E(e.event.start),document.getElementById("modal-end").textContent=E(e.event.end),document.getElementById("modal-room").textContent=((o=t.room)==null?void 0:o.name)||"—";const p=document.getElementById("modal-grabacion-container");p&&p.classList.add("hidden");const g=document.getElementById("view-class-link");g&&g.classList.add("hidden")}else{const d=document.getElementById("modal-program");d&&d.parentElement&&(d.parentElement.style.display="");const l=document.getElementById("modal-magister-view");l&&l.parentElement&&(l.parentElement.style.display="");const c=document.getElementById("modal-modality");c&&c.parentElement&&(c.parentElement.style.display="");const m=document.getElementById("modal-teacher");m&&m.parentElement&&(m.parentElement.style.display="");const v=document.getElementById("modal-description");v&&(v.textContent=t.description||"");const p=t.programa||(typeof t.magister=="string"?t.magister:((r=t.magister)==null?void 0:r.name)||"No especificado");d&&(d.textContent=p),l&&(l.textContent=p),c&&(c.innerHTML=T(t.modality)),m&&(m.textContent=t.profesor||t.teacher||"—"),document.getElementById("modal-start").textContent=E(e.event.start),document.getElementById("modal-end").textContent=E(e.event.end),document.getElementById("modal-room").textContent=((u=t.room)==null?void 0:u.name)||"—";const g=document.getElementById("modal-grabacion-container"),w=document.getElementById("modal-grabacion-link");g&&w&&(t.url_grabacion?(w.href=t.url_grabacion,g.classList.remove("hidden")):(g.classList.add("hidden"),w.removeAttribute("href")));const y=document.getElementById("view-class-link");if(y){const k=M(e.event);B&&k&&t.type==="clase"?(y.href=`${B}/${k}`,y.classList.remove("hidden")):(y.classList.add("hidden"),y.removeAttribute("href"))}}document.getElementById("eventModal").classList.remove("hidden")}function W(e){var p,g;const t=e.event.extendedProps||{},n=t.programa||(typeof t.magister=="string"?t.magister:((p=t.magister)==null?void 0:p.name)||"Sin programa"),o=t.profesor||t.teacher||"Sin encargado",r=((g=t.room)==null?void 0:g.name)||"Sin sala",u=E(e.event.start),d=E(e.event.end),l=t.type==="manual"?"🚩 Evento Especial":"Clase",c=`${e.event.title}
📌 ${l}
👨‍🏫 ${o}
🏛️ ${n}
🏫 ${r}
🕒 ${u} - ${d}`;e.el.setAttribute("title",c.trim()),t.type==="manual"&&e.el.classList.add("evento-manual");const m=new Date;(e.event.end||e.event.start)<m&&e.el.classList.add("evento-pasado")}window.closeModal=function(){document.getElementById("eventModal").classList.add("hidden")},document.getElementById("eventModal").addEventListener("click",e=>{e.target.id==="eventModal"&&window.closeModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&window.closeModal()})});
