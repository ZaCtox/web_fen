let r=1,l=4;document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".hci-form-section .hci-field-error");if(e){const n=e.closest(".hci-form-section");n&&n.dataset.step&&(r=parseInt(n.dataset.step)||1)}const t=document.getElementById("is-editing"),o=t&&t.value==="1";if(l=o?3:4,o){const n=document.querySelector('.hci-progress-sidebar [data-step="3"]');n&&(n.style.display="none");const s=document.querySelector('.hci-progress-sidebar [data-step="4"]');if(s){const d=s.querySelector(".hci-progress-step-number");d&&(d.textContent="3"),s.setAttribute("data-step","3"),s.setAttribute("onclick","navigateToStep(3)")}window.updateWizardProgressSteps=function(d){document.querySelectorAll('.hci-progress-step-vertical:not([style*="display: none"])').forEach((m,p)=>{const w=p+1;m.classList.remove("completed","active"),w<d?m.classList.add("completed"):w===d&&m.classList.add("active")})};const c=document.getElementById("current-step"),a=document.getElementById("progress-percentage");c&&(c.textContent="Paso 1 de 3"),a&&(a.textContent="33%");const u=document.getElementById("progress-bar");u&&(u.style.height="33%")}g(r),y(r),document.querySelectorAll(".hci-input, .hci-select, .hci-textarea").forEach(n=>{n.addEventListener("blur",function(){I(this)}),n.addEventListener("input",function(){E(this),S()})})});window.nextStep=function(){h()&&r<l&&(r++,g(r),y(r))};window.prevStep=function(){r>1&&(r--,g(r),y(r))};window.navigateToStep=function(e){const t=document.getElementById("is-editing");t&&t.value,!(e>l)&&(e<=r||h())&&(r=e,g(r),y(r))};window.cancelForm=function(){window.hasUnsavedChanges&&window.hasUnsavedChanges()?window.showUnsavedChangesModal(window.location.origin+"/usuarios"):window.location.href=window.location.origin+"/usuarios"};function g(e){document.querySelectorAll(".hci-form-section").forEach(i=>{i.classList.remove("active")});const o=document.getElementById(f(e));o?(o.classList.add("active"),o.scrollIntoView({behavior:"smooth",block:"start"})):console.warn(`No se encontró la sección para el paso ${e}: ${f(e)}`),window.updateWizardProgressSteps&&window.updateWizardProgressSteps(e),f(e)==="resumen"&&S()}function y(e){const t=document.getElementById("progress-bar"),o=document.getElementById("progress-percentage"),i=document.getElementById("current-step"),n=e/l*100;t&&(t.style.height=n+"%"),o&&(o.textContent=Math.round(n)+"%"),i&&(i.textContent=`Paso ${e} de ${l}`);const s=document.getElementById("prev-btn"),c=document.getElementById("next-btn"),a=document.getElementById("submit-btn");s&&(s.style.display=e>1?"flex":"none"),c&&(c.style.display=e<l?"flex":"none"),a&&(a.style.display=e===l?"flex":"none")}function f(e){const t=document.getElementById("is-editing");return t&&t.value==="1"?["personal","foto","resumen"][e-1]||"resumen":["personal","foto","notificacion","resumen"][e-1]||"resumen"}function h(){const e=document.getElementById(f(r));if(!e||f(r)==="resumen")return!0;const t=e.querySelectorAll("input[required], select[required], textarea[required]");let o=!0;return t.forEach(i=>{i.value.trim()?E(i):(I(i),o=!1)}),o||B("Por favor, completa todos los campos requeridos antes de continuar."),o}function B(e){let t=document.getElementById("step-error-message");t||(t=document.createElement("div"),t.id="step-error-message",t.className="hci-error-message",document.querySelector(".hci-container").insertBefore(t,document.querySelector(".hci-wizard-layout"))),t.innerHTML=`
        <div class="hci-error-content">
            <span class="hci-error-icon">⚠️</span>
            <span class="hci-error-text">${e}</span>
        </div>
    `,setTimeout(()=>{t&&t.remove()},5e3)}function I(e){const t=e.checkValidity(),o=e.closest(".hci-field"),i=o==null?void 0:o.querySelector(".hci-field-error");if(t)E(e);else if(e.classList.add("border-red-500"),e.classList.remove("border-gray-300"),!i){const n=document.createElement("div");n.className="hci-field-error",n.textContent=e.validationMessage||"Este campo es requerido",o==null||o.appendChild(n)}}function E(e){e.classList.remove("border-red-500"),e.classList.add("border-gray-300");const t=e.closest(".hci-field"),o=t==null?void 0:t.querySelector(".hci-field-error");o&&o.remove()}function S(){var v,m,p;const e=((v=document.querySelector('input[name="name"]'))==null?void 0:v.value)||"",t=((m=document.querySelector('input[name="email"]'))==null?void 0:m.value)||"",o=((p=document.querySelector('select[name="rol"]'))==null?void 0:p.value)||"",i=document.getElementById("is-editing"),n=i&&i.value==="1",s=document.getElementById("summary-name"),c=document.getElementById("summary-email"),a=document.getElementById("summary-rol"),u=document.getElementById("summary-password");s&&(s.textContent=e||"No especificado"),c&&(c.textContent=t||"No especificado"),a&&(a.textContent=o||"No especificado"),u&&(n?u.textContent="No se modifica":u.textContent="Se generará automáticamente");const d=document.getElementById("email-notification");d&&(d.textContent=t||"el correo especificado")}window.submitForm=function(){if(console.log("submitForm called, currentStep:",r),h()){if(console.log("Validation passed, submitting form"),!document.getElementById("form-loading-overlay")){const t=document.createElement("div");t.id="form-loading-overlay",t.className="loading-overlay",t.innerHTML=`
                <div class="loading-overlay-content">
                    <div class="inline-block w-12 h-12 animate-spin rounded-full border-4 border-solid border-[#4d82bc] border-r-transparent"></div>
                    <p class="text-gray-700 dark:text-gray-300 font-medium">Procesando...</p>
                </div>
            `,document.body.appendChild(t)}const e=document.querySelector("form.hci-form");if(e)console.log("Submitting form:",e.action,e.method),e.submit();else{console.error("Form not found!");const t=document.querySelector("form");t?(console.log("Using fallback form:",t.action,t.method),t.submit()):console.error("No form found at all!")}}else console.log("Validation failed")};window.handleDragOver=function(e){e.preventDefault(),e.stopPropagation();const t=document.getElementById("foto-drop-zone");t&&t.classList.add("hci-file-drop-active")};window.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation();const t=document.getElementById("foto-drop-zone");t&&t.classList.remove("hci-file-drop-active")};window.handleFotoDrop=function(e){e.preventDefault(),e.stopPropagation();const t=document.getElementById("foto-drop-zone");t&&t.classList.remove("hci-file-drop-active");const o=e.dataTransfer.files;o.length>0&&b(o[0])};window.handleFotoSelect=function(e){const t=e.target.files[0];t&&b(t)};function x(e){return["image/jpeg","image/jpg","image/png","image/webp"].includes(e.type)?e.size>2*1024*1024?(alert("La imagen no puede exceder los 2MB."),!1):!0:(alert("Por favor, selecciona una imagen JPG, PNG o WEBP."),!1)}function b(e){if(x(e)){const t=new DataTransfer;t.items.add(e),document.getElementById("foto-input").files=t.files;const o=URL.createObjectURL(e);document.getElementById("foto-preview").src=o,document.getElementById("foto-name").textContent=e.name,document.getElementById("foto-preview-info").classList.remove("hidden"),document.getElementById("foto-drop-text").textContent="Foto seleccionada"}}window.clearFoto=function(){document.getElementById("foto-input").value="",document.getElementById("foto-preview-info").classList.add("hidden"),document.getElementById("foto-drop-text").textContent="Arrastra tu foto aquí";const e="https://ui-avatars.com/api/?name=Foto&background=84b6f4&color=000000&size=300&bold=true&font-size=0.4";document.getElementById("foto-preview").src=e};
