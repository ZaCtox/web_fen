let s=1;const l=3,w={1:[1,2,3],2:[4,5,6]};function v(){const e=document.getElementById("anio-select"),t=document.getElementById("numero-select");if(!e||!t)return;const n=parseInt(e.value),r=w[n]||[],o=t.value;console.log("üîÑ Wizard actualizando trimestres:",{anio:n,trimestres:r,trimestreActual:o}),t.innerHTML='<option value="">-- Selecciona un trimestre --</option>',r.forEach(function(c){const i=document.createElement("option");i.value=c,i.textContent="Trimestre "+c,o&&o==c&&(i.selected=!0,console.log("‚úÖ Wizard manteniendo trimestre:",c)),t.appendChild(i)}),d()}function d(){const e=document.getElementById("anio-select"),t=document.getElementById("anio-ingreso-select"),n=document.getElementById("numero-select"),r=document.querySelector('input[name="fecha_inicio"]'),o=document.querySelector('input[name="fecha_fin"]'),c=document.getElementById("summary-anio");c&&e&&(c.textContent=e.value?`A√±o ${e.value}`:"--");const i=document.getElementById("summary-anio-ingreso");i&&t&&(i.textContent=t.value?t.value:"--");const a=document.getElementById("summary-trimestre");if(a&&n){const g=n.value;if(g){const I={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"}[g];a.textContent=`Trimestre ${I}`}else a.textContent="--"}const h=document.getElementById("summary-fecha-inicio");h&&r&&(h.textContent=r.value?new Date(r.value).toLocaleDateString("es-CL"):"--");const y=document.getElementById("summary-fecha-fin");y&&o&&(y.textContent=o.value?new Date(o.value).toLocaleDateString("es-CL"):"--")}function m(e){const t=document.querySelectorAll(".hci-form-section"),n=document.querySelectorAll(".hci-progress-step-vertical");t.forEach(o=>{o.classList.remove("active")});const r=document.getElementById(p(e));r&&(r.classList.add("active"),r.scrollIntoView({behavior:"smooth",block:"start"})),n.forEach((o,c)=>{c+1<=e?(o.classList.add("completed"),o.classList.add("active")):(o.classList.remove("completed"),o.classList.remove("active"))}),B(e)}function B(e){const t=document.getElementById("progress-bar"),n=document.getElementById("progress-percentage"),r=document.getElementById("current-step"),o=document.getElementById("prevBtn"),c=document.getElementById("nextBtn"),i=document.getElementById("submitBtn"),a=e/l*100;t&&(t.style.height=a+"%"),n&&(n.textContent=Math.round(a)+"%"),r&&(r.textContent=`Paso ${e} de ${l}`),o&&(o.style.display=e===1?"none":"inline-flex"),c&&(c.style.display=e===l?"none":"inline-flex"),i&&(i.style.display=e===l?"inline-flex":"none")}function p(e){return["informacion","fechas","resumen"][e-1]||"informacion"}window.nextStep=function(){u()&&s<l&&(s++,m(s),d())};window.prevStep=function(){s>1&&(s--,m(s))};window.navigateToStep=function(e){(e<=s||u())&&(s=e,m(s))};window.cancelForm=function(){window.hasUnsavedChanges&&window.hasUnsavedChanges()?window.showUnsavedChangesModal(window.location.origin+"/periods"):window.location.href=window.location.origin+"/periods"};function u(){const e=document.getElementById(p(s));if(!e)return!0;const t=e.querySelectorAll("input[required], select[required], textarea[required]");let n=!0;return t.forEach(r=>{r.value.trim()?f(r):(E(r),n=!1)}),n||S("Por favor, completa todos los campos requeridos antes de continuar."),n}function S(e){let t=document.getElementById("step-error-message");if(!t){t=document.createElement("div"),t.id="step-error-message",t.className="hci-error-message";const n=document.querySelector(".hci-container");n&&n.insertBefore(t,document.querySelector(".hci-wizard-layout"))}t.innerHTML=`
        <div class="hci-error-content">
            <span class="hci-error-icon">‚ö†Ô∏è</span>
            <span class="hci-error-text">${e}</span>
        </div>
    `,setTimeout(()=>{t&&t.remove()},5e3)}function E(e){const t=e.checkValidity(),n=e.closest(".hci-field"),r=n==null?void 0:n.querySelector(".hci-field-error");if(t)f(e);else if(e.classList.add("border-red-500"),e.classList.remove("border-gray-300"),!r){const o=document.createElement("div");o.className="hci-field-error",o.textContent=e.validationMessage||"Este campo es requerido",n==null||n.appendChild(o)}}function f(e){e.classList.remove("border-red-500"),e.classList.add("border-gray-300");const t=e.closest(".hci-field"),n=t==null?void 0:t.querySelector(".hci-field-error");n&&n.remove()}window.submitForm=function(){if(u()){const e=document.querySelector(".hci-form"),t=document.getElementById("submitBtn");t&&(t.disabled=!0,t.innerHTML=`
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Guardando...
            `),e.submit()}};document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("anio-select");e&&e.addEventListener("change",v),document.querySelectorAll(".hci-input, .hci-select, .hci-textarea, input, select, textarea").forEach(n=>{n.addEventListener("blur",function(){this.hasAttribute("required")&&E(this)}),n.addEventListener("input",function(){f(this),d()}),n.addEventListener("change",d)}),v(),m(1),d()});
