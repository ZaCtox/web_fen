window.closeModal=function(){console.log("ğŸšª Cerrando modal...");const g=document.getElementById("modal"),p=document.getElementById("eventModal");g&&g.classList.add("hidden"),p&&p.classList.add("hidden");const h=document.getElementById("event-form");if(h){h.reset();const x=document.getElementById("event_id");x&&(x.value="")}console.log("âœ… Modal cerrado y formulario reseteado")};document.addEventListener("DOMContentLoaded",function(){var _,M,P,D,F,O;const g=document.getElementById("calendar"),p=((_=document.querySelector('meta[name="csrf-token"]'))==null?void 0:_.content)||"",h=((M=document.querySelector('meta[name="store-url"]'))==null?void 0:M.content)||"",x=((P=document.querySelector('meta[name="clases-show-base"]'))==null?void 0:P.content)||"/clases",j=((D=document.querySelector('meta[name="user-id"]'))==null?void 0:D.content)||null,w=((F=document.querySelector('meta[name="es-visor"]'))==null?void 0:F.content)==="1",l=document.getElementById("magister-filter"),u=document.getElementById("room-filter"),v=document.getElementById("anio-ingreso-filter"),d=document.getElementById("anio-filter"),i=document.getElementById("trimestre-filter"),I=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),$=e=>{const t=new Date(e),n=t.getTimezoneOffset()*6e4;return new Date(t-n).toISOString().slice(0,16)},G=e=>`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${{presencial:"bg-green-100 text-green-800",online:"bg-indigo-100 text-indigo-800",hibrida:"bg-yellow-100 text-yellow-800"}[e]||"bg-gray-100 text-gray-800"}">${e}</span>`,R=e=>{const t=String(e).match(/^clase-(\d+)-/);return t?t[1]:null},A=e=>{var n;const t=R(e.id);return t||((n=e.extendedProps)==null?void 0:n.clase_id)||null},N=e=>{var z,V,W;const t=e.extendedProps.type==="clase",n=e.extendedProps.type==="break",o=I(e.start),r=I(e.end);if(n){const oe=Math.round((e.end-e.start)/6e4),ae=((z=e.extendedProps.room)==null?void 0:z.name)||"Sin sala",se=e.extendedProps.description||"";return`
              <div class="text-center">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">${e.title}</h2>
                <div class="inline-block p-4 rounded-lg ${e.title.includes("COFFEE")?"bg-orange-50 dark:bg-orange-900/20":"bg-red-50 dark:bg-red-900/20"}">
                  <p class="text-6xl mb-3">${e.title.includes("COFFEE")?"â˜•":"ğŸ½ï¸"}</p>
                  <p class="text-lg font-medium text-gray-700 dark:text-gray-300">${se}</p>
                </div>
                <div class="mt-4 space-y-2 text-sm text-gray-600 dark:text-gray-400">
                  <div><span class="font-medium">â° Inicio:</span> ${o}</div>
                  <div><span class="font-medium">â° Fin:</span> ${r}</div>
                  <div><span class="font-medium">âŒ› DuraciÃ³n:</span> ${oe} minutos</div>
                  <div><span class="font-medium">ğŸ« Sala:</span> ${ae}</div>
                </div>
              </div>
            `}const a=t?A(e):null,c=((V=e.extendedProps.magister)==null?void 0:V.name)||"â€”",m=e.extendedProps.modality||"â€”",f=e.extendedProps.profesor||e.extendedProps.teacher||"â€”",b=((W=e.extendedProps.room)==null?void 0:W.name)||"Sin sala",B=e.extendedProps.url_zoom||null,y=e.extendedProps.url_grabacion||null,E=e.extendedProps.type==="manual"&&e.extendedProps.description||"",Q=B?`<a href="${B}" target="_blank" rel="noopener"
           class="inline-flex items-center rounded px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700">ğŸ”— Zoom</a>`:"",ee=t&&a?`<a href="${x}/${a}" target="_blank" rel="noopener"
           class="inline-flex items-center rounded px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700"
           title="Ver detalle de la clase">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
             <path d="M10 4a6 6 0 104.472 10.028l4.75 4.75 1.414-1.414-4.75-4.75A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"/>
           </svg>
        </a>`:"",te=E?`<div class="mt-2 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line">${E}</div>`:"",ne=y?`<div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                <p class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  <span class="text-2xl">ğŸ¥</span>
                  GrabaciÃ³n disponible
                </p>
                <a href="${y}" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow transition-all duration-200 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  Ver GrabaciÃ³n en YouTube
                </a>
              </div>`:"";return`
      <div class="flex items-start justify-between gap-3">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">${e.title}</h2>
        <div class="flex items-center gap-2">${Q}${ee}</div>
      </div>
      ${te}
      ${ne}
      <div class="mt-3 space-y-1 text-sm">
        <div><span class="font-medium">Programa:</span> ${c}</div>
        <div><span class="font-medium">Modalidad:</span> ${G(m)}</div>
        <div><span class="font-medium">Profesor:</span> ${f}</div>
        <div><span class="font-medium">Inicio:</span> ${o}</div>
        <div><span class="font-medium">Fin:</span> ${r}</div>
        <div><span class="font-medium">Sala:</span> ${b}</div>
      </div>
    `},H=((O=document.querySelector('meta[name="inicio-trimestre"]'))==null?void 0:O.content)||null;console.log("ğŸ“… Fecha inicial del calendario:",H);const s=new FullCalendar.Calendar(g,{initialView:window.innerWidth<768?"listWeek":"timeGridWeek",initialDate:void 0,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},locale:"es",buttonText:{today:"Hoy",month:"Mes",week:"Semana",day:"DÃ­a",list:"Lista"},firstDay:1,slotMinTime:"08:00:00",slotMaxTime:"22:00:00",slotDuration:"00:30:00",slotLabelFormat:{hour:"numeric",minute:"2-digit",hour12:!1},slotLabelInterval:"01:00:00",allDaySlot:!1,expandRows:!0,editable:!1,selectable:!w,select:J,eventClick:K,events:{url:g.dataset.url,extraParams:()=>{const e={magister_id:l.value||"",room_id:u.value||"",anio_ingreso:v.value||"",anio:d.value||"",trimestre:i.value||""};return console.log("ğŸ“¤ Enviando parÃ¡metros al API:",e),e},success:e=>{console.log("âœ… Eventos recibidos:",e.length),console.log("ğŸ“¦ Detalle eventos:",e)},failure:e=>console.error("âŒ Error cargando eventos:",e)},eventDidMount:Z,viewDidMount:function(e){const t="week-view-active",n=document.body;e.view.type==="timeGridWeek"?n.classList.add(t):n.classList.remove(t),e.view.type.startsWith("list")?(s.setOption("height","auto"),s.setOption("contentHeight","auto")):(s.setOption("height",window.innerHeight+200),s.setOption("contentHeight",null))},windowResize:function(){window.innerWidth<768?s.changeView("listWeek"):s.changeView("timeGridWeek")},datesSet:e=>{const t=new Date(e.start),o=(6-t.getDay()+7)%7,r=new Date(t);r.setDate(t.getDate()+o),L(r)}});s.render(),l!=null&&l.value||Swal.fire({title:"Filtra por magÃ­ster",text:"Para una mejor visualizaciÃ³n, selecciona un magÃ­ster desde el filtro superior.",icon:"info",confirmButtonText:"Entendido",timer:6e3,timerProgressBar:!0});const S=document.getElementById("cancel");S&&S.addEventListener("click",()=>{s.unselect(),window.closeModal()}),["modal","eventModal"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("click",n=>{n.target===t&&(s.unselect(),window.closeModal())})}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(s.unselect(),window.closeModal())}),[l,u,v].filter(Boolean).forEach(e=>{e.addEventListener("change",()=>{s.refetchEvents()})}),d&&d.addEventListener("change",()=>{q(),d.value&&i.value&&C(parseInt(d.value),parseInt(i.value)),s.refetchEvents()}),i&&i.addEventListener("change",()=>{d.value&&i.value&&C(parseInt(d.value),parseInt(i.value)),s.refetchEvents()});const k=document.getElementById("clear-filters");k&&k.addEventListener("click",()=>{if(l&&(l.value=""),u&&(u.value=""),d&&(d.value=""),i){i.innerHTML='<option value="">Todos</option>';for(let e=1;e<=6;e++){const t=document.createElement("option");t.value=e,t.textContent=`Trimestre ${e}`,i.appendChild(t)}}s.refetchEvents()});function q(){if(!i||!d)return;const e=parseInt(d.value),t=i.value;if(i.innerHTML='<option value="">Todos</option>',e===1)for(let n=1;n<=3;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,n.toString()===t&&(o.selected=!0),i.appendChild(o)}else if(e===2)for(let n=4;n<=6;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,n.toString()===t&&(o.selected=!0),i.appendChild(o)}else for(let n=1;n<=6;n++){const o=document.createElement("option");o.value=n,o.textContent=`Trimestre ${n}`,i.appendChild(o)}}async function C(e,t){try{const o=await(await fetch(`/api/periodo-fecha-inicio?anio=${e}&trimestre=${t}&anio_ingreso=${v.value}`)).json();if(o.fecha_inicio){const r=new Date(o.fecha_inicio);s.changeView("timeGridWeek",r),await L(r)}}catch(n){console.error("Error navegando al trimestre:",n),Swal.fire({icon:"error",title:"Error de navegaciÃ³n",text:"No se pudo navegar al trimestre seleccionado."})}}async function L(e){if(d&&i&&d.value&&i.value){const r=`Trimestre ${{1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"}[i.value]||i.value} del aÃ±o ${d.value}`;document.getElementById("current-period-text").textContent=r;return}const t=e.toISOString().split("T")[0],n=v?v.value:"";try{const o=`/api/periodo-por-fecha?fecha=${t}${n?`&anio_ingreso=${n}`:""}`,a=await(await fetch(o)).json(),c={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"},m=a.periodo?`Trimestre ${c[a.periodo.numero]||a.periodo.numero} del aÃ±o ${a.periodo.anio}`:"Fuera de perÃ­odos acadÃ©micos";document.getElementById("current-period-text").textContent=m}catch(o){console.error("Error cargando perÃ­odo:",o),document.getElementById("current-period-text").textContent="Error"}}function J(e){if(w){s.unselect();return}T();const t=document.getElementById("magister_id"),n=document.getElementById("room_id");t&&(l!=null&&l.value)&&(t.value=l.value),n&&(u!=null&&u.value)&&(n.value=u.value),document.getElementById("modal-header").textContent="Crear Evento",document.getElementById("start_time").value=$(e.start),document.getElementById("end_time").value=$(e.end),document.getElementById("modal").classList.remove("hidden"),s.unselect()}function K(e){const t=document.getElementById("event-modal-body");t.innerHTML=N(e.event);const n=document.getElementById("delete-btn"),o=document.getElementById("edit-btn");w?(n.classList.add("hidden"),o.classList.add("hidden")):e.event.extendedProps.type==="manual"?(n.classList.remove("hidden"),n.setAttribute("data-id",e.event.id.replace("event-","")),o.classList.remove("hidden"),o.onclick=()=>U(e.event)):(n.classList.add("hidden"),o.classList.add("hidden")),document.getElementById("eventModal").classList.remove("hidden")}function U(e){var n,o;T();const t=r=>{const a=new Date(r),c=a.getTimezoneOffset()*6e4;return new Date(a-c).toISOString().slice(0,16)};document.getElementById("event_id").value=e.id.replace("event-",""),document.getElementById("modal-title-input").value=e.title,document.getElementById("modal-description-input").value=e.extendedProps.description||"",document.getElementById("magister_id").value=((n=e.extendedProps.magister)==null?void 0:n.id)??"",document.getElementById("room_id").value=((o=e.extendedProps.room)==null?void 0:o.id)||"",document.getElementById("start_time").value=t(e.start),document.getElementById("end_time").value=t(e.end),document.getElementById("modal-header").textContent="Editar Evento",document.getElementById("eventModal").classList.add("hidden"),document.getElementById("modal").classList.remove("hidden")}document.getElementById("event-form").addEventListener("submit",X);function X(e){e.preventDefault(),e.stopPropagation(),console.log("ğŸš€ Iniciando guardado de evento...");const t=(document.getElementById("event_id").value||"").trim(),n={title:document.getElementById("modal-title-input").value,description:document.getElementById("modal-description-input").value,magister_id:document.getElementById("magister_id").value||null,start_time:document.getElementById("start_time").value,end_time:document.getElementById("end_time").value,room_id:document.getElementById("room_id").value||null,type:"manual",created_by:j};console.log("ğŸ“¦ Data a enviar:",n);const o=t?`/events/${t}`:h,r=t?"PUT":"POST";if(console.log("ğŸ”— Endpoint:",o),console.log("ğŸ“¡ Method:",r),!o){console.error('âŒ Falta meta[name="store-url"] o endpoint vacÃ­o'),Swal.fire({icon:"error",title:"ConfiguraciÃ³n faltante",text:"No se encontrÃ³ la URL para guardar eventos."});return}console.log("ğŸ“¤ Enviando peticiÃ³n fetch..."),Swal.fire({title:"Guardando evento...",html:'<div class="flex justify-center"><div class="inline-block w-12 h-12 animate-spin rounded-full border-4 border-solid border-[#4d82bc] border-r-transparent"></div></div>',showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1}),fetch(o,{method:r,headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":p},body:JSON.stringify(n)}).then(async a=>{if(console.log("ğŸ“¥ Respuesta recibida:",a.status,a.statusText),!a.ok){let m=null;try{m=await a.json(),console.log("âŒ Error JSON del servidor:",m)}catch(f){console.log("âŒ Error parseando JSON:",f)}throw m||{message:"Error al guardar"}}const c=await a.json();return console.log("âœ… Respuesta exitosa del servidor:",c),c}).then(a=>{console.log("ğŸ‰ Evento guardado exitosamente:",a),console.log("ğŸ”„ Cerrando modal y actualizando calendario..."),s.unselect(),s.refetchEvents(),window.closeModal(),Swal.fire({icon:"success",title:"Evento guardado",timer:1500,showConfirmButton:!1}),console.log("âœ… Proceso completado exitosamente")}).catch(a=>{console.error("ğŸ’¥ Error en el proceso de guardado:",a),Swal.fire({icon:"error",title:"Error al guardar el evento",text:a&&a.message?a.message:"Revisa los datos ingresados"})})}document.getElementById("delete-btn").addEventListener("click",Y);function Y(){const e=this.getAttribute("data-id");confirm("Â¿EstÃ¡s seguro de eliminar este evento?")&&fetch(`/events/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":p}}).then(t=>{t.ok?(s.unselect(),s.refetchEvents(),window.closeModal(),Swal.fire({icon:"success",title:"Evento Eliminado",timer:1500,showConfirmButton:!1})):Swal.fire({icon:"error",title:"Error al eliminar el evento",text:"Intenta nuevamente"})})}function Z(e){var y,E;const t=e.event.extendedProps||{},n=t.programa||(typeof t.magister=="string"?t.magister:((y=t.magister)==null?void 0:y.name)||"Sin programa"),o=t.profesor||t.teacher||"Sin encargado",r=((E=t.room)==null?void 0:E.name)||"Sin sala",a=I(e.event.start),c=I(e.event.end),m=t.type==="manual"?"ğŸš© Evento Manual":"Clase",f=`${e.event.title}
ğŸ“Œ ${m}
ğŸ‘¨â€ğŸ« ${o}
ğŸ›ï¸ ${n}
ğŸ« ${r}
ğŸ•’ ${a} - ${c}`;e.el.setAttribute("title",f.trim()),t.type==="manual"&&e.el.classList.add("evento-manual");const b=new Date;(e.event.end||e.event.start)<b&&e.el.classList.add("evento-pasado")}function T(){console.log("ğŸ”„ Reseteando formulario...");const e=document.getElementById("event_id"),t=document.getElementById("event-form"),n=document.getElementById("start_time"),o=document.getElementById("end_time");e&&(e.value=""),t&&t.reset(),n&&(n.value=""),o&&(o.value=""),console.log("âœ… Formulario reseteado")}});
