document.addEventListener("DOMContentLoaded",function(){var I;const v=document.getElementById("calendar"),f=document.getElementById("magister-filter"),h=document.getElementById("room-filter"),p=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),b=e=>`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${{presencial:"bg-green-100 text-green-800",online:"bg-indigo-100 text-indigo-800",hibrida:"bg-yellow-100 text-yellow-800"}[e]||"bg-gray-100 text-gray-800"}">${e||"‚Äî"}</span>`,y=((I=document.querySelector('meta[name="clases-show-base"]'))==null?void 0:I.content)||null,B=e=>{const t=String(e).match(/^clase-(\d+)-/);return t?t[1]:null},i=new FullCalendar.Calendar(v,{initialView:window.innerWidth<768?"listWeek":"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},locale:"es",buttonText:{today:"Hoy",month:"Mes",week:"Semana",day:"D√≠a",list:"Lista"},firstDay:1,slotMinTime:"08:30:00",slotMaxTime:"21:00:00",slotDuration:"01:10:00",allDaySlot:!1,expandRows:!0,editable:!1,selectable:!1,eventClick:k,events:{url:v.dataset.url,extraParams:()=>({magister_id:f.value||"",room_id:h.value||""}),failure:e=>console.error("Error cargando eventos:",e)},eventDidMount:L,viewDidMount:function(e){const t="week-view-active",n=document.body;e.view.type==="timeGridWeek"?n.classList.add(t):n.classList.remove(t),e.view.type.startsWith("list")?(i.setOption("height","auto"),i.setOption("contentHeight","auto")):(i.setOption("height",window.innerHeight-150),i.setOption("contentHeight",null))},windowResize:function(){window.innerWidth<768?i.changeView("listWeek"):i.changeView("timeGridWeek")},datesSet:e=>{const t=new Date(e.start),o=(6-t.getDay()+7)%7,r=new Date(t);r.setDate(t.getDate()+o),S(r)}});i.render(),f.value||Swal.fire({title:"Filtra por mag√≠ster",text:"Para una mejor visualizaci√≥n, selecciona un mag√≠ster desde el filtro superior.",icon:"info",confirmButtonText:"Entendido",timer:6e3,timerProgressBar:!0}),document.getElementById("btnAnterior").addEventListener("click",()=>E("anterior")),document.getElementById("btnSiguiente").addEventListener("click",()=>E("siguiente"));async function E(e){const t=i.getDate().toISOString().split("T")[0];try{const n=await fetch(`/api/trimestre-${e}?fecha=${t}`);if(n.status===404){const l=await(await fetch("/api/trimestres-todos")).json();if(!l.length){Swal.fire({icon:"warning",title:"Sin trimestres registrados",text:"No hay ning√∫n per√≠odo acad√©mico cargado en el sistema."});return}const c=l.map(a=>new Date(a.fecha_inicio)),m=new Date(t);let s=null;e==="anterior"?s=c.filter(a=>a<m).sort((a,d)=>d-a)[0]:s=c.filter(a=>a>m).sort((a,d)=>a-d)[0],s?i.gotoDate(s.toISOString().split("T")[0]):Swal.fire({icon:"info",title:"Trimestre no disponible",text:e==="anterior"?"Ya est√°s en el trimestre m√°s antiguo registrado.":"Ya est√°s en el trimestre m√°s reciente registrado."});return}const o=await n.json();o.fecha_inicio&&i.gotoDate(o.fecha_inicio)}catch(n){console.error("Error consultando trimestre:",n),Swal.fire({icon:"error",title:"Error de conexi√≥n",text:"No se pudo consultar los trimestres. Intenta nuevamente."})}}[f,h].forEach(e=>{e.addEventListener("change",()=>i.refetchEvents())});const w=document.getElementById("clear-filters");w&&w.addEventListener("click",()=>{f.value="",h.value="",i.refetchEvents()});async function S(e){const t=e.toISOString().split("T")[0];try{const o=await(await fetch(`/api/periodo-por-fecha?fecha=${t}`)).json(),r={1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI"},l=o.periodo?`Trimestre ${r[o.periodo.numero]||o.periodo.numero} del a√±o ${o.periodo.anio}`:"Fuera de per√≠odos acad√©micos";document.getElementById("current-period-text").textContent=l}catch(n){console.error("Error cargando per√≠odo:",n),document.getElementById("current-period-text").textContent="Error"}}function k(e){var g,u;const t=e.event.extendedProps||{};document.getElementById("modal-title").textContent=e.event.title;const n=document.getElementById("modal-description");n&&(n.textContent=t.description||"");const o=t.programa||(typeof t.magister=="string"?t.magister:((g=t.magister)==null?void 0:g.name)||"No especificado"),r=document.getElementById("modal-program");r&&(r.textContent=o);const l=document.getElementById("modal-magister-view");l&&(l.textContent=o);const c=document.getElementById("modal-modality");c&&(c.innerHTML=b(t.modality));const m=document.getElementById("modal-teacher");m&&(m.textContent=t.profesor||t.teacher||"‚Äî"),document.getElementById("modal-start").textContent=p(e.event.start),document.getElementById("modal-end").textContent=p(e.event.end),document.getElementById("modal-room").textContent=((u=t.room)==null?void 0:u.name)||"‚Äî";const s=document.getElementById("modal-grabacion-container"),a=document.getElementById("modal-grabacion-link");s&&a&&(t.url_grabacion?(a.href=t.url_grabacion,s.classList.remove("hidden")):(s.classList.add("hidden"),a.removeAttribute("href")));const d=document.getElementById("view-class-link");if(d){const x=B(e.event.id);y&&x&&t.type==="clase"?(d.href=`${y}/${x}`,d.classList.remove("hidden")):(d.classList.add("hidden"),d.removeAttribute("href"))}document.getElementById("eventModal").classList.remove("hidden")}function L(e){var g,u;const t=e.event.extendedProps||{},n=t.programa||(typeof t.magister=="string"?t.magister:((g=t.magister)==null?void 0:g.name)||"Sin programa"),o=t.profesor||t.teacher||"Sin encargado",r=((u=t.room)==null?void 0:u.name)||"Sin sala",l=p(e.event.start),c=p(e.event.end),m=t.type==="manual"?"üö© Evento Especial":"Clase",s=`${e.event.title}
üìå ${m}
üë®‚Äçüè´ ${o}
üèõÔ∏è ${n}
üè´ ${r}
üïí ${l} - ${c}`;e.el.setAttribute("title",s.trim()),t.type==="manual"&&e.el.classList.add("evento-manual");const a=new Date;(e.event.end||e.event.start)<a&&e.el.classList.add("evento-pasado")}window.closeModal=function(){document.getElementById("eventModal").classList.add("hidden")},document.getElementById("eventModal").addEventListener("click",e=>{e.target.id==="eventModal"&&window.closeModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&window.closeModal()})});
