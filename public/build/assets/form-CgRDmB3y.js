(()=>{const t=(i,n=document)=>n.querySelector(i),$=(i,n=document)=>Array.from(n.querySelectorAll(i));function L(i,n){const[e,o]=(i||"00:00").split(":").map(Number),a=new Date(2e3,1,1,e,o,0);a.setMinutes(a.getMinutes()+n);const r=d=>d<10?"0"+d:""+d;return`${r(a.getHours())}:${r(a.getMinutes())}`}function k(i){return Object.entries(i).filter(([n,e])=>e!=null&&e!=="").map(([n,e])=>`${encodeURIComponent(n)}=${encodeURIComponent(e)}`).join("&")}function T(){const i=t("#magister");if(!i)return{};try{return JSON.parse(i.dataset.agrupados||"{}")}catch{return{}}}function R(){const i=t("#magister"),n=t("#course_id"),e=t("#period_id"),o=t("#periodo_info"),a=t("#trimestre"),r=t("#anio");if(!i||!n)return;const d=T();i.addEventListener("change",()=>{const s=i.value;n.innerHTML='<option value="">-- Asignatura --</option>',e&&(e.value=""),o&&(o.innerHTML="<option>Selecciona un curso para ver el perÃ­odo</option>"),a&&(a.value=""),r&&(r.value=""),d[s]&&d[s].forEach(c=>{const l=document.createElement("option");l.value=c.id,l.textContent=c.nombre,l.dataset.period_id=c.period_id,l.dataset.periodo=c.periodo,l.dataset.period_numero=c.numero??"",l.dataset.period_anio=c.anio??"",n.appendChild(l)})}),n.addEventListener("change",()=>{var _,g,y,h;const s=n.options[n.selectedIndex],c=((_=s==null?void 0:s.dataset)==null?void 0:_.period_id)??"",l=((g=s==null?void 0:s.dataset)==null?void 0:g.periodo)??"",v=((y=s==null?void 0:s.dataset)==null?void 0:y.period_numero)||"",p=((h=s==null?void 0:s.dataset)==null?void 0:h.period_anio)||"";e&&(e.value=c),o&&(o.innerHTML=`<option>${l?"ðŸ“˜ "+l:"Sin periodo asignado"}</option>`),a&&(a.value=v),r&&(r.value=p)}),function(){const c=n.options[n.selectedIndex];if(!c)return;const l=c.dataset.period_numero||"",v=c.dataset.period_anio||"";a&&(a.value=l),r&&(r.value=v)}()}function j(){const i=t("#modality"),n=t("#room_id");if(!i||!n)return;const e=()=>{i.value==="online"?(n.value="",n.disabled=!0):n.disabled=!1;const o=t("#slots-wrap"),a=t("#slots");i.value==="online"&&(a&&(a.innerHTML=""),o&&o.classList.add("hidden"))};e(),i.addEventListener("change",e)}window.disponibilidadSala=function(){const i=t("#form-clase"),n=(i==null?void 0:i.dataset.urlDisponibilidad)||"";return{checking:!1,available:null,conflicts:[],timer:null,payload(e={}){var o,a,r,d,s,c;return{room_id:((o=t("#room_id"))==null?void 0:o.value)||"",period_id:((a=t("#period_id"))==null?void 0:a.value)||"",dia:((r=t('select[name="dia"]'))==null?void 0:r.value)||"",hora_inicio:((d=t('input[name="hora_inicio"]'))==null?void 0:d.value)||"",hora_fin:((s=t('input[name="hora_fin"]'))==null?void 0:s.value)||"",modality:((c=t("#modality"))==null?void 0:c.value)||"",...e}},debounceCheck(e={}){clearTimeout(this.timer),this.timer=setTimeout(()=>this.check(e),400)},async check(e={}){var r;const o=this.payload(e);if(o.modality==="online"||!o.period_id||!o.dia||!o.hora_inicio||!o.hora_fin){this.available=!0,this.conflicts=[];return}if(!o.room_id){this.available=!0,this.conflicts=[];return}this.checking=!0,this.available=null,this.conflicts=[];const a=k(o);try{const s=await(await fetch(`${n}?${a}`,{headers:{Accept:"application/json"}})).json();this.available=!!s.available,this.conflicts=s.conflicts||[]}catch(d){this.available=!0,this.conflicts=[],console.error("Error disponibilidad:",d)}finally{this.checking=!1,(r=t('button[type="submit"]'))==null||r.toggleAttribute("disabled",this.available===!1)}},initCreate(){const e=(a,r="change")=>{const d=t(a);d&&d.addEventListener(r,()=>this.debounceCheck())};e("#room_id"),e("#period_id"),e('select[name="dia"]'),e('input[name="hora_inicio"]',"input"),e('input[name="hora_fin"]',"input"),e("#modality");const o=t("#course_id");o==null||o.addEventListener("change",()=>this.debounceCheck()),this.debounceCheck()}}},window.disponibilidadSalaEdit=function(i){const n=window.disponibilidadSala(),e=n.payload.bind(n);return n.payload=function(o={}){return e({exclude_id:i,...o})},n.initEdit=function(){this.initCreate()},n};function M(){var o,a;const i=t("#help-huecos");if(!i)return;const n=parseInt(((o=t("#block_hours"))==null?void 0:o.value)||"1",10),e=parseInt(((a=t("#buffer_mins"))==null?void 0:a.value)||"10",10);i.textContent=`Busca huecos libres de ${n} ${n===1?"hora":"horas"} con ${e} minutos de holgura antes y despuÃ©s.`}function D(){const i=t("#btn-horarios");if(!i)return;const n=t("#slots-wrap"),e=t("#slots"),o=t("#period_id"),a=t("#room_id"),r=t('select[name="dia"]'),d=t("#modality"),s=t("#block_hours"),c=t("#buffer_mins"),l=i.dataset.urlHorarios||"",v=i.dataset.excludeId?parseInt(i.dataset.excludeId,10):null;$("#block_hours, #buffer_mins").forEach(p=>p.addEventListener("change",M)),$("#buffer_mins").forEach(p=>p.addEventListener("input",M)),M(),i.addEventListener("click",async()=>{const p=o==null?void 0:o.value,_=a==null?void 0:a.value,g=r==null?void 0:r.value,y=d==null?void 0:d.value;if(!p){alert("Primero selecciona una asignatura para obtener el perÃ­odo.");return}if(y!=="online"&&!_){alert("Selecciona una sala (o cambia a modalidad online).");return}if(!g){alert("Selecciona el dÃ­a.");return}const h=Math.max(30,parseInt((s==null?void 0:s.value)||"1",10)*60),N=Math.max(0,Math.min(60,parseInt((c==null?void 0:c.value)||"10",10))),q={period_id:p,room_id:_,dia:g,modality:y,exclude_id:v??"",desde:"08:00",hasta:"22:00",min_block:h,buffer:N};try{const C=`${l}?${k(q)}`,I=await(await fetch(C,{headers:{"X-Requested-With":"XMLHttpRequest"}})).json();e.innerHTML="",n.classList.remove("hidden"),I.slots&&I.slots.length?(I.slots.forEach(E=>{let w=E.start,H=0;for(;L(w,h)<=E.end;){const f=w,x=L(f,h),u=document.createElement("button");u.type="button",u.className="px-3 py-1 text-xs rounded bg-green-100 text-green-800 hover:bg-green-200",u.textContent=`${f}â€“${x}`,u.addEventListener("click",()=>{const m=t('input[name="hora_inicio"]'),b=t('input[name="hora_fin"]');m&&(m.value=f,m.dispatchEvent(new Event("input",{bubbles:!0}))),b&&(b.value=x,b.dispatchEvent(new Event("input",{bubbles:!0})))}),e.appendChild(u),w=L(w,15),H++}if(!H){const f=L(E.end,-h);if(f>=E.start){const x=E.end,u=document.createElement("button");u.type="button",u.className="px-3 py-1 text-xs rounded bg-green-100 text-green-800 hover:bg-green-200",u.textContent=`${f}â€“${x}`,u.addEventListener("click",()=>{const m=t('input[name="hora_inicio"]'),b=t('input[name="hora_fin"]');m&&(m.value=f,m.dispatchEvent(new Event("input",{bubbles:!0}))),b&&(b.value=x,b.dispatchEvent(new Event("input",{bubbles:!0})))}),e.appendChild(u)}}}),e.children.length||(e.innerHTML='<span class="text-sm text-red-600">No hay huecos del tamaÃ±o solicitado en los slots disponibles.</span>')):e.innerHTML='<span class="text-sm text-red-600">No hay huecos libres con las condiciones actuales.</span>'}catch(C){console.error(C),alert("No se pudo obtener la disponibilidad.")}})}function S(){R(),j(),D()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S()})();
